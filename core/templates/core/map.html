{% extends 'core/base.html' %}

{% block title %}Map{% endblock %}

{% block content %}



    <!-- This is the search bar -->
    <div style="margin-bottom: 10px;">
        <input type="text" id="search-bar" placeholder="Search for a restaurant"
               style="padding: 10px; width: 300px; font-size: 14px;">
        <button id="search-button" style="padding: 10px; font-size: 14px;">Search</button>
    </div>
    <!-- This is the filter bar -->
    <div style="margin-bottom: 10px;">
        <label for="radiusInput">Radius (miles):</label>
        <input type="number" id="radiusInput" value="5">
        <label for="ratingInput">Minimum Rating:</label>
        <input type="number" id="ratingInput" value="4.5" step="0.1" min="0" max="5">
        <button id="filterButton" style="padding: 10px; font-size: 14px;">Filter</button>
    </div>

    <!-- This is the map -->
    <div id="map" style="height: 500px; width: 100%;"></div>

    <script>
        let map;
        let service;
        let markers = [];
        // we are initializing the map
        function initMap() {
            const userLocation = { lat: 33.7490, lng: -84.3880 };


            map = new google.maps.Map(document.getElementById('map'), {
                center: userLocation,
                zoom: 13
            });

            // we are initializing places
            service = new google.maps.places.PlacesService(map);

            // this is the onclick for search
            document.getElementById('search-button').addEventListener('click', function() {
                const query = document.getElementById('search-bar').value;
                searchPlaces(query); // there is a function for this later
            });

            //this is the onclick for filter
            document.getElementById('filterButton').addEventListener('click', function() {
                const radius = parseFloat(document.getElementById('radiusInput').value) * 1609.34;  // Convert miles to meters
                const minRating = parseFloat(document.getElementById('ratingInput').value);
                searchNearby(userLocation, radius, minRating); // there is a function for this later
            });
        }
        //for search button
        function searchPlaces(query) {
            const request = {
                query: query,
                fields: ['name', 'geometry'],
            };


            service.findPlaceFromQuery(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    const place = results[0];  // Get the first result
                    if (place.geometry && place.geometry.location) {

                        map.setCenter(place.geometry.location);
                        map.setZoom(15);


                        clearMarkers();


                        const marker = new google.maps.Marker({
                            position: place.geometry.location,
                            map: map,
                            title: place.name //adds a marker for the place
                        });


                        const infowindow = new google.maps.InfoWindow({
                            content: place.name
                        });
                        marker.addListener('click', function() {
                            infowindow.open(map, marker);
                        });
                    }
                } else {
                    alert('Place not found');
                }
            });
        }

        // for the filter button
        function searchNearby(location, radius, minRating) {
            const request = {
                location: location,
                radius: radius,
                type: ['restaurant']
            };

            service.nearbySearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && results) {
                    clearMarkers();  // Clear previous markers

                    // looking at rating
                    const filteredResults = results.filter(place => place.rating >= minRating && place.rating <= 5);


                    filteredResults.forEach(function(place) {
                        if (place.geometry && place.geometry.location) {
                            addMarker(place); // adding a marker for each place
                        }
                    });

                    if (filteredResults.length === 0) {
                        alert('No restaurants found with the specified criteria.');
                    }
                } else {
                    alert('No restaurants found.');
                }
            });
        }


        function addMarker(place) {
            const marker = new google.maps.Marker({
                position: place.geometry.location,
                map: map,
                title: place.name
            });
            markers.push(marker);

            const infowindow = new google.maps.InfoWindow({
                content: `<strong>${place.name}</strong><br>Rating: ${place.rating}`
            });

            marker.addListener('click', function() {
                infowindow.open(map, marker);
            });
        }


        function clearMarkers() {
            for (let i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }
    </script>


    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRWVo1v50HrzJZ_ckYSR7WbR3vWwroh0Q&libraries=places&callback=initMap">
    </script>

{% endblock %}
